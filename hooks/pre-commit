#!/bin/bash

# -------------------------------------------------
# Pre-commit hook for Spark Connect C++ Client
# This hook runs quick checks before allowing a commit
#
# To bypass this hook:
#   git commit --no-verify
# -------------------------------------------------

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}********************************************${NC}"
echo -e "${BLUE}  Pre-Commit Hook: Quick Checks${NC}"
echo -e "${BLUE}********************************************${NC}"
echo ""

if [ ! -f "Makefile" ]; then
    echo -e "${RED}Error: Makefile not found. Are you in the project root?${NC}"
    exit 1
fi

# --------------------------------------------------------
# Only check C++ files that are being committed
# --------------------------------------------------------
cpp_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|h|hpp)$' || true)

if [ -z "$cpp_files" ]; then
    echo -e "${GREEN}No C++ files to check${NC}"
    echo ""
    exit 0
fi

echo -e "${YELLOW}Checking C++ files:${NC}"
echo "$cpp_files" | sed 's/^/  - /'
echo ""

# --------------------------------------------------------
# Check for basic syntax
# --------------------------------------------------------
echo -e "${BLUE}[1/2] Checking build...${NC}"
if ! make all > /dev/null 2>&1; then
    echo -e "${RED}✗ Build failed${NC}"
    echo ""
    echo -e "${YELLOW}Fix compilation errors before committing.${NC}"
    echo -e "${YELLOW}To commit anyway: git commit --no-verify${NC}"
    exit 1
fi
echo -e "${GREEN}Build OK${NC}"
echo ""

# --------------------------------------------------------
# Build tests
# --------------------------------------------------------
echo -e "${BLUE}[2/2] Checking tests build...${NC}"
if ! make build-tests > /dev/null 2>&1; then
    echo -e "${RED}✗ Tests build failed${NC}"
    echo ""
    echo -e "${YELLOW}Fix test compilation errors before committing.${NC}"
    echo -e "${YELLOW}To commit anyway: git commit --no-verify${NC}"
    exit 1
fi
echo -e "${GREEN} Tests build OK${NC}"
echo ""

echo -e "${GREEN}********************************************${NC}"
echo -e "${GREEN} PRE-COMMIT CHECKS PASSED${NC}"
echo -e "${GREEN}********************************************${NC}"
echo -e "${YELLOW}Note: Full tests will run before push${NC}"
echo ""

exit 0
