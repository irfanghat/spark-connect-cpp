#!/bin/bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}*********************************************${NC}"
echo -e "${BLUE}  Pre-Push Hook: Run Tests${NC}"
echo -e "${BLUE}*********************************************${NC}"
echo ""

current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "detached")

echo -e "${YELLOW}Branch:${NC} $current_branch"
echo -e "${YELLOW}Remote:${NC} $1"
echo ""

if [ ! -d "build" ]; then
    echo -e "${RED}Error: build/ directory not found.${NC}"
    echo -e "${YELLOW}Run the build first:${NC}"
    echo -e "${YELLOW}  mkdir build && cd build && cmake .. && make -j$(nproc)${NC}"
    exit 1
fi

cd build

# -----------------------------------------------------------
# Run tests
# -----------------------------------------------------------
echo -e "${BLUE}Running tests (ctest)...${NC}"
echo ""

if ! ctest --output-on-failure; then
    echo ""
    echo -e "${RED}*********************************************${NC}"
    echo -e "${RED} TESTS FAILED${NC}"
    echo -e "${RED}*********************************************${NC}"
    echo ""
    echo -e "${YELLOW}Make sure Docker is running and Spark is up:${NC}"
    echo -e "${YELLOW}  docker compose up spark --build${NC}"
    echo ""
    echo -e "${YELLOW}Please fix the failing tests before pushing.${NC}"
    echo -e "${YELLOW}To push anyway (not recommended): git push --no-verify${NC}"
    echo ""
    exit 1
fi

echo ""
echo -e "${GREEN}*********************************************${NC}"
echo -e "${GREEN} ALL TESTS PASSED${NC}"
echo -e "${GREEN}*********************************************${NC}"
echo -e "${GREEN}Proceeding with push...${NC}"
echo ""

exit 0
